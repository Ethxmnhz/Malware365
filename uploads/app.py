import os
from flask import Flask, render_template, request, redirect, url_for
import requests

app = Flask(__name__)

VIRUSTOTAL_API_KEY = '655ff61776fa5397a152a7ac6a64afcd78041ba664a6cb14659ad66753c0c8f6'
THRESHOLD = 3
temp_dir = 'storedfile'

if not os.path.exists(temp_dir):
    os.makedirs(temp_dir)

@app.route('/', methods=['GET', 'POST'])
def index():
    if request.method == 'POST':
        file = request.files.get('file')  # Use request.files.get() to avoid KeyError
        if file:
            response = requests.post(
                'https://www.virustotal.com/vtapi/v2/file/scan',
                files={'file': file},
                params={'apikey': VIRUSTOTAL_API_KEY}
            )
            if response.status_code == 204:
                return render_template('wait.html')
            else:
                json_response = response.json()
                scan_id = json_response['scan_id']
                return redirect(url_for('result', scan_id=scan_id))
    return render_template('index.html')

@app.route('/result/<scan_id>')
def result(scan_id):
    response = requests.get(
        'https://www.virustotal.com/vtapi/v2/file/report',
        params={'apikey': VIRUSTOTAL_API_KEY, 'resource': scan_id}
    )
    json_response = response.json()
    positives = json_response['positives']
    total = json_response['total']
    percentage = (positives / total) * 100
    if percentage >= THRESHOLD:
        verdict = 'Malicious'
    else:
        verdict = 'Safe'
    return render_template('result.html', verdict=verdict, percentage=percentage)

if __name__ == '__main__':
    app.run(debug=True)
